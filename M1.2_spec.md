# Milestone 1.2 Specification: FastAPI Skeleton + Health/Version Endpoints

## Overview

**Goal:** Establish a running API baseline with core health monitoring and version endpoints.

**Duration:** 1-2 days

**Dependencies:** Milestone 1.1 (Repo, CI, and Dev Scaffolding) must be complete.

## Objectives

Create a minimal but production-ready FastAPI application with:

- Essential health and readiness endpoints for monitoring
- Version endpoint for deployment tracking
- Structured logging foundation
- Basic error handling middleware
- Docker containerization support

## Technical Requirements

### 1. FastAPI Application Structure

**File Structure:**

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI app creation and configuration
│   ├── api/
│   │   ├── __init__.py
│   │   └── health.py        # Health/version endpoints
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py        # Environment configuration
│   │   └── logging.py       # Structured logging setup
│   └── middleware/
│       ├── __init__.py
│       └── error_handler.py # Basic error middleware
├── tests/
│   ├── __init__.py
│   └── test_health.py       # Health endpoint tests
├── Dockerfile
├── requirements.txt
└── pyproject.toml
```

### 2. Core Endpoints

#### `/healthz` - Health Check

- **Method:** GET
- **Purpose:** Basic liveness check for load balancers/orchestrators
- **Response:** 200 OK with `{"status": "ok"}`
- **Dependencies:** None (always returns OK if app is running)

#### `/readyz` - Readiness Check

- **Method:** GET
- **Purpose:** Indicates when app is ready to serve traffic
- **Response:** 200 OK with `{"status": "ready"}` or 503 with error details
- **Dependencies:** Future database/Redis connectivity checks (placeholder for now)

#### `/version` - Version Information

- **Method:** GET
- **Purpose:** Deployment tracking and debugging
- **Response:** 200 OK with version metadata
- **Schema:**

```json
{
  "version": "0.1.0",
  "build_date": "2024-01-01T00:00:00Z",
  "commit_hash": "abc123...",
  "python_version": "3.11.x"
}
```

### 3. Configuration Management

**Environment Variables:**

- `LOG_LEVEL`: Logging level (DEBUG, INFO, WARN, ERROR) - default INFO
- `API_HOST`: Host binding - default "0.0.0.0"
- `API_PORT`: Port binding - default 8000
- `VERSION`: Application version - default from pyproject.toml

**Configuration Class:**

- Pydantic Settings for type safety and validation
- Environment-based configuration with sensible defaults
- No secrets in this milestone (database/Redis configs come later)

### 4. Structured Logging

**Requirements:**

- JSON-formatted logs for production parsing
- Request ID correlation for tracing
- Configurable log levels
- Standard fields: timestamp, level, message, request_id, endpoint

**Log Examples:**

```json
{"timestamp": "2024-01-01T12:00:00Z", "level": "INFO", "message": "Application startup", "component": "main"}
{"timestamp": "2024-01-01T12:00:01Z", "level": "INFO", "message": "GET /healthz", "request_id": "req_abc123", "status_code": 200, "duration_ms": 1.2}
```

### 5. Error Handling Middleware

**Global Exception Handler:**

- Catch unhandled exceptions
- Return consistent JSON error responses
- Log errors with full context
- Never expose internal details in production

**Error Response Schema:**

```json
{
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "An unexpected error occurred",
    "request_id": "req_abc123"
  }
}
```

### 6. CORS Configuration

**Setup:**

- Allow localhost:3000 for frontend development
- Configurable origins for different environments
- Standard headers and methods

## Implementation Details

### FastAPI App Configuration

```python
# app/main.py structure
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

def create_app() -> FastAPI:
    app = FastAPI(
        title="Your Morning Brief API",
        description="Personalized news curation service",
        version="0.1.0",
        docs_url="/docs",
        redoc_url="/redoc"
    )

    # Add middleware
    # Add routers
    # Configure CORS

    return app

app = create_app()
```

### Health Endpoints Implementation

```python
# app/api/health.py structure
from fastapi import APIRouter
from pydantic import BaseModel

router = APIRouter()

class HealthResponse(BaseModel):
    status: str

class VersionResponse(BaseModel):
    version: str
    build_date: str
    commit_hash: str
    python_version: str

@router.get("/healthz", response_model=HealthResponse)
async def health_check():
    # Implementation

@router.get("/readyz", response_model=HealthResponse)
async def readiness_check():
    # Implementation

@router.get("/version", response_model=VersionResponse)
async def version_info():
    # Implementation
```

## Testing Requirements

### Unit Tests

**Coverage Requirements:**

- All endpoints return correct status codes
- Response schemas match specifications
- Error handling produces expected responses
- Configuration loads correctly from environment

**Test Cases:**

1. `test_health_endpoint_returns_200_ok()`
2. `test_readiness_endpoint_returns_200_ok()`
3. `test_version_endpoint_returns_correct_format()`
4. `test_error_handler_catches_exceptions()`
5. `test_cors_headers_present()`

### Integration Tests

**Test FastAPI TestClient:**

- Full request/response cycle
- Middleware execution
- JSON response parsing

## Docker Integration

### Dockerfile Requirements

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Copy and install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY app/ ./app/

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/healthz || exit 1

# Run application
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Docker Compose Integration

Update `docker-compose.dev.yml` to include the backend service:

```yaml
services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - LOG_LEVEL=DEBUG
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
```

## Quality Gates

### Code Quality

- `ruff` linting passes with zero warnings
- `black` formatting applied
- `mypy` type checking passes with strict mode
- All tests pass with `pytest`

### Performance

- Health endpoint responds in < 10ms locally
- Application startup time < 5 seconds
- Memory usage < 100MB at idle

### Security

- No hardcoded secrets
- CORS properly configured
- Error responses don't leak internal information

## Acceptance Criteria

### Functional Requirements

1. **Local Development:**
   - `uvicorn app.main:app --reload` starts successfully
   - `curl http://localhost:8000/healthz` returns `{"status": "ok"}` with 200 status
   - `curl http://localhost:8000/readyz` returns `{"status": "ready"}` with 200 status
   - `curl http://localhost:8000/version` returns valid version information

2. **Docker Environment:**
   - `docker build -t ymb-backend backend/` succeeds
   - `docker run -p 8000:8000 ymb-backend` starts and serves requests
   - Docker health checks pass within 30 seconds

3. **Development Stack:**
   - `make up` starts all services including backend
   - Backend service shows healthy in `docker-compose ps`
   - All endpoints accessible through docker-compose network

### Non-Functional Requirements

1. **Logging:**
   - All requests logged with structured format
   - Log level configurable via environment variable
   - No sensitive data in logs

2. **Error Handling:**
   - Unhandled exceptions return 500 with consistent error format
   - Error responses include request ID for correlation
   - Internal error details not exposed to clients

3. **Documentation:**
   - FastAPI auto-generated docs available at `/docs`
   - All endpoints documented with proper schemas
   - README updated with API endpoints and usage

## Deliverables

1. **Source Code:**
   - Complete FastAPI application structure
   - Health/version endpoints implementation
   - Configuration and logging setup
   - Error handling middleware

2. **Tests:**
   - Unit tests for all endpoints
   - Integration tests using TestClient
   - Test coverage > 90%

3. **Documentation:**
   - Updated README with API usage
   - Code comments for complex logic
   - OpenAPI schema generated by FastAPI

4. **Infrastructure:**
   - Dockerfile for containerization
   - Updated docker-compose configuration
   - Make targets for common operations

## Success Metrics

- ✅ `GET /healthz` returns 200 locally and in Docker
- ✅ All CI checks pass (lint, type-check, tests)
- ✅ Application starts in < 5 seconds
- ✅ Health endpoint responds in < 10ms
- ✅ Zero linting/typing errors
- ✅ Test coverage > 90%

## Next Steps

Upon completion of Milestone 1.2, the foundation will be ready for:

- **Milestone 1.3:** Database integration and connection health checks
- **Milestone 1.4:** RSS ingestion endpoints
- **Milestone 2.x:** Business logic APIs (topics, articles, etc.)

The health endpoints established here will serve as the foundation for monitoring throughout the application lifecycle.
